<?php
/*
 * Copyright (C) 2014-2018 The OpenExam Project
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation; either version 2
 * of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
 */

// 
// File:    answers.phtml
// 
// Author:  Ahsan Shahzad (MedfarmDoIT)
//          Anders LÃ¶vgren (BMC-IT)
// 

if (strtotime($exam->endtime) < time()) {
        $exam->show_save = true;
} else {
        $exam->show_save = false;
}
if ($exam->decoded | $exam->enquiry) {
        $exam->show_readonly = true;
} else {
        $exam->show_readonly = false;
}

?>

<?= Phalcon\Tag::stylesheetLink("css/pdf-rendering.css?rev=1"); ?>

<style>
    div[correction="completed"] > div.q-body,
    div[correction="finalized"] > div.q-body {
        border-left: 10px solid white;
        padding-left: 10px;
    }
    div[correction="partial"] > div.q-body {
        border-left: 10px solid orange;
        padding-left: 10px;
    }
    div[correction="waiting"] > div.q-body,
    div[correction=""] > div.q-body {
        border-left: 10px solid green;
        padding-left: 10px;
    }

    div.correction-section-box {
        overflow: hidden;
        background-color: ghostwhite;
        margin-bottom: 10px;
    }
    div.correction-section-box[corrector="0"] {
        filter: grayscale(80%);
    }
    div.correction-section-head {
        background-color: lavender;
        padding: 10px;
    }

    div.student-answer-box {
        background-color: white;
        border: 1px solid #e0e0e0;
        border-radius: 5px;
        margin-top: 10px;
        padding: 15px;
        margin-bottom: 20px;
    }

    #mainview {
        background-color: rgba(0, 0, 0, 0.3);
        width: 99%;  
        height: 85%;
        padding: 0;
        margin-top: -20px;
    }
    #mainview h3 {
        color: white;
        text-align: center;
    }

    input.q-points:required {
        background-color: #ffffff;
    }
    input.q-points:required:invalid {
        background-color: #feff99;
    }    
    .savable {
        display: <?= $exam->show_save ? '' : 'none' ?>
    }
    @media print {
        body {
            font-size: smaller;
        }
        .no-print {
            display: none;
        }
        input.q-points {
            padding: 10px;
        }
        #mainview {
            color: black;
            background-color: white;
        }
        #mainview h3 {
            padding-top: 20px;
            color: black;
        }
        div.correction-section-box {
            border-radius: 5px; 
            margin-left: 10px; 
            margin-top: 10px; 
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.2), 0 5px 20px 0 rgba(0, 0, 0, 0.2);    
            background-color: ghostwhite;
        }
    }
    @media screen {
        .on-print {
            display: none;
        }
    }
    @media screen and (min-width: 900px) {
        #mainview h3 {
            background-color: rgba(0,0,0,0.8);
            padding: 9px;
            z-index: 2;
        }    
    }
</style>

<h2 class="on-print">
    <?= Phalcon\Tag::image(array($this->config->brand->logo->file, "height" => "55px", "style" => "padding-right:20px")); ?><?= $exam->name ?>
</h2>

<div id="mainview">
    <?php if ($exam->show_readonly) : ?>
            <h3><?= $tr->_("Answer correction for %heading%", array('heading' => $heading)) ?></h3>
    <?php else : ?>
            <h3><?= $tr->_("Correct the answers for %heading%", array('heading' => $heading)) ?></h3>
    <?php endif; ?>

    <?php foreach ($questions as $question) : ?>
            <?php
            $correctAns = array();

            foreach ($question->correctors as $corrector) {
                    if ($this->user->getPrincipalName() == $corrector->user) {
                            $question->corrector = $corrector->id;
                            break;
                    }
            }

            foreach ($answers as $answer) {
                    if ($answer->question_id == $question->id) {
                            $result = $answer->result;
                            break;
                    }
            }

            if ($exam->show_readonly) {
                    $question->corrector = "none";
            } elseif (!isset($question->corrector)) {
                    $question->corrector = 0;
            }

            ?>

            <?php if ($loading == 'question') : ?>
                    <div class="q-wrapper correction-section-box" corrector="<?= $question->corrector ?>">
                <?php else : ?>
                        <div class="q-wrapper correction-section-box" corrector="<?= $question->corrector ?>" correction="<?= $result->correction ?>">
                    <?php endif; ?>

                    <?php if (!$exam->show_readonly && $loading != 'question'): ?>
                            <?= Phalcon\Tag::image(array("img/not-corrected.gif", "style" => "position: absolute; z-index: 1; right: 0px; width: 5%; min-width: 60px;", "id" => $question->id . "-corrected", "class" => "not-corrected")); ?>
                    <?php endif; ?>
                    <div class="q-heading correction-section-head">
                        <span style="color:#333333; font-weight:normal">
                            <i class="fa fa-pencil-square-o"></i> 
                            <?= $tr->_("Question no. %slot%", array('slot' => $question->slot)) ?>
                        </span>
                    </div>

                    <?php
                    $questParts = json_decode($question->quest, true);
                    if (isset($questParts['highlight-q'])) :
                            unset($questParts['highlight-q']);
                    endif;

                    ?>
                    <div class="q-body" style="padding:10px;">
                        <?php
                        $qPartCounter = 1;
                        $perOptPoints = array();

                        ?>
                        <?php foreach ($questParts as $qPartTitle => $qPart): ?>
                                <div class="q-part-wrapper" style=" <?= $loading != 'question' ? '1px dashed #dedede' : 'none' ?>">

                                    <?php if (count($questParts) > 1): ?>
                                            <div style="q-part-heading">
                                                <span style="font-weight: bold; color:#4285f4">Part <?= $qPartTitle ?>:</span>
                                            </div>
                                    <?php endif; ?>

                                    <div class="q-part-body" >

                                        <div class="q-part-txt">
                                            <?= $qPart['q_text'] ?>
                                        </div>

                                        <div class="q-part-resources">
                                            <?php
                                            foreach ($qPart['resources'] as $resTitle => $resUrl) {
                                                    $type = basename(dirname($resUrl));
                                                    $path = $this->config->application->mediaDir . $type . DIRECTORY_SEPARATOR . basename(urldecode($resUrl));
                                                    $href = $this->url->get($resUrl);
                                                    $name = $resTitle;

                                                    // 
                                                    // Use resource viewer:
                                                    // 
                                                    $this->partial('partials/resource-file-viewer', array(
                                                            'type' => $type, 'path' => $path,
                                                            'href' => $href, 'name' => $name,
                                                            'url'  => $this->url
                                                    ));
                                            }

                                            ?>
                                        </div>

                                        <?php if ($qPart['ans_area']['type'] == 'choicebox'): ?>
                                                <div>
                                                    <?php if (count($qPart['ans_area']['data'])): ?>
                                                            <ul style="margin: 5px 0 0 30px">
                                                                <?php foreach ($qPart['ans_area']['data'] as $opt => $correct): ?>
                                                                        <?php if ($correct == '1'): ?>
                                                                                <li style="color:green"><?= $opt ?></li>
                                                                                <?php $correctAns[$question->id][$qPartTitle][] = $opt; ?>
                                                                        <?php else: ?>
                                                                                <li><?= $opt ?></li>        
                                                                        <?php endif; ?>
                                                                <?php endforeach; ?>
                                                            </ul>
                                                    <?php endif; ?>
                                                </div>

                                                <?php
                                                if (is_array($correctAns[$question->id][$qPartTitle]) && count($correctAns[$question->id][$qPartTitle])):
                                                        $perOptPoints[$question->id][$qPartTitle] = ($qPart['q_points'] / count($correctAns[$question->id][$qPartTitle]));
                                                endif;

                                                ?>

                                        <?php endif; ?>

                                        <?php
                                        if ($loading != 'question'):

                                                // 
                                                // Filter answer for this question from list of answers
                                                // 
                                                $qSpecificAns = array();
                                                foreach ($answers as $answer) {
                                                        if ($answer->question_id == $question->id) {
                                                                $qSpecificAns[] = $answer;
                                                        }
                                                }

                                                ?>

                                                <?php
                                                foreach ($qSpecificAns as $qSpecAns):
                                                        $result = $qSpecAns->getResult();
                                                        $scoreData = (is_object($result) && $result->count() ? json_decode($result->score, true) : array());
                                                        if ($exam->show_readonly || (count($scoreData) && $result->correction != 'partial')):

                                                                ?>
                                                                <script>
                                                                        $("#<?= $question->id ?>-corrected").hide();
                                                                        $("#<?= $question->id ?>-corrected").parent().find('.st-ans-ul').css('background-color', '#F9F9F9');
                                                                </script>
                                                        <?php endif; ?>

                                                        <div class="student-answer-box">
                                                            <div class="q-part-txt-student-ans">
                                                                <?php $ansData = json_decode($qSpecAns->answer, true); ?>
                                                                <span style="color:#990000;"><i class="fa fa-arrow-circle-right"></i></span> 
                                                                <span style="color:#000; font-weight:bold">
                                                                    <?= $tr->_("Student's answer") ?>
                                                                </span>
                                                                <?php
                                                                if (isset($correctAns[$question->id][$qPartTitle])) {
                                                                        $correctAnsPart = $correctAns[$question->id][$qPartTitle];
                                                                } else {
                                                                        $correctAnsPart = array();
                                                                }

                                                                ?>
                                                                <?php $totalCorrect = 0; ?>
                                                                <?php if (count($ansData[$qPartTitle]['ans'])): ?>
                                                                        <ul class="st-ans-ul" style="margin: 5px 0 0 30px; list-style:none; background-color:#F5FAF5; padding:5px; border-left:5px solid #f0f0f0; max-width:95%">
                                                                            <?php foreach ($ansData[$qPartTitle]['ans'] as $stAns): ?>
                                                                                    <?php if ($qPart['ans_area']['type'] == 'choicebox'): ?>
                                                                                            <li style="color:<?= (in_array($stAns, $correctAnsPart) ? 'green' : 'red') ?>">
                                                                                                <i class="fa fa-<?= (in_array($stAns, $correctAnsPart) ? 'check' : 'times') ?>"></i> 
                                                                                                <?= $stAns ?>
                                                                                                <?php in_array($stAns, $correctAnsPart) ? ++$totalCorrect : --$totalCorrect; ?>
                                                                                            </li>
                                                                                    <?php elseif ($qPart['ans_area']['type'] == 'canvas'): ?>
                                                                                            <li><img src="<?= $stAns['canvasUrl'] ?>" max-width="50%" /></li>
                                                                                    <?php else: ?>
                                                                                            <li><?= $stAns ?></li>
                                                                                    <?php endif; ?>
                                                                                    <?php if (empty($ansData[$qPartTitle]['ans'][0])): ?>
                                                                                            <li>
                                                                                                <i><?= $tr->_("Student did not answer this question.") ?></i>
                                                                                            </li>
                                                                                    <?php endif; ?>
                                                                            <?php endforeach; ?>
                                                                            <?php
                                                                            if ($totalCorrect < 0) {
                                                                                    $totalCorrect = 0;
                                                                            }

                                                                            ?>
                                                                        </ul>
                                                                <?php else: ?>
                                                                        <span style="background-color:#FEFF99">
                                                                            <i><?= $tr->_("Student did not answer this question part.") ?></i>
                                                                        </span>
                                                                <?php endif; ?>
                                                            </div>
                                                            <?php if ($qPart['ans_area']['type'] == 'choicebox' && count($correctAnsPart) && $totalCorrect && $totalCorrect != count($correctAnsPart)) : ?>
                                                                    <div style="color:orange; margin-left:35px">
                                                                        <i class="fa fa-warning"></i>  
                                                                        <?= $tr->_("Student's answer is partially correct") ?>
                                                                    </div>
                                                            <?php endif; ?>

                                                            <div class="q-part-student-score savable" style="padding-left: 35px; margin-top: 10px; display: <?= $qPart['q_points'] == 0 ? 'none' : '' ?>">
                                                                <i class="fa fa-certificate" style="color:#D84B4B"></i>
                                                                <span style="color:#000;">
                                                                    <?= $tr->_("Points:") ?>
                                                                    <span style="margin-left: 15px">
                                                                        <?php
                                                                        // 
                                                                        // Fill in score if max is zero on this question part.
                                                                        // 
                                                                        if (isset($qPart['q_points']) && $qPart['q_points'] == 0 && !isset($scoreData[$qPartTitle])) {
                                                                                $scoreData[$qPartTitle] = 0;
                                                                                printf("<script>resyncableResults.push('%d')</script>\n", $result->answer_id);
                                                                        }

                                                                        // 
                                                                        // Define answer result score. Make sure to watch out for floatval('') == 0 ...
                                                                        // 
                                                                        if (isset($scoreData[$qPartTitle])) {
                                                                                $score = floatval($scoreData[$qPartTitle]);
                                                                        } elseif ($qPart['ans_area']['type'] == 'choicebox') {
                                                                                $score = round($perOptPoints[$question->id][$qPartTitle] * $totalCorrect, 2);
                                                                        } else {
                                                                                $score = '';
                                                                        }

                                                                        ?>
                                                                        <?php if (!$exam->show_readonly && $question->corrector): ?>
                                                                                <input type="text" class="form-control q-points changeable" style="max-width: 80px" qst-id="<?= $qSpecAns->question_id ?>" ans-id="<?= $qSpecAns->id ?>" res-id="<?= count($scoreData) ? $result->id : 0 ?>" q-part="<?= $qPartTitle ?>" value="<?= $score ?>" max-pt="<?= floatval($qPart['q_points']) ?>" required="required">								
                                                                        <?php else: ?>
                                                                                <?= floatval($scoreData[$qPartTitle]) ?>
                                                                        <?php endif; ?>	
                                                                    </span>
                                                                    <span style="color: #4285f4; float: right; margin-right: 10px">[Max: <?= floatval($qPart['q_points']) ?>]</span>
                                                                </span>
                                                            </div>
                                                        </div>

                                                        <?php if (count($qSpecificAns)): ?>
                                                                <?php if (!$exam->show_readonly && $question->corrector): ?>
                                                                        <?php if (count($questParts) == $qPartCounter): ?>
                                                                                <div class="savable" style="padding-bottom: 10px; padding-left:35px">
                                                                                    <i class="fa fa-comments"></i>
                                                                                    Comments:<br />
                                                                                    <textarea class="form-control changeable no-print" 
                                                                                              placeholder="<?= $tr->_("Add your comments here for the student") ?>" 
                                                                                              style="margin-left: 15px; width:30%" 
                                                                                              qst-id="<?= $qSpecAns->question_id ?>" 
                                                                                              ans-id="<?= $qSpecAns->id ?>">
                                                                                                  <?= $result->comment ?>
                                                                                    </textarea>
                                                                                </div>
                                                                                <div class="savable" style="padding-bottom: 10px; padding-left: 45px;">
                                                                                    <input class="btn btn-success save-result no-print" 
                                                                                           type="button" 
                                                                                           qst-id="<?= $qSpecAns->question_id ?>" 
                                                                                           ans-id="<?= $qSpecAns->id ?>" 
                                                                                           value="<?= $tr->_("Save result for this question") ?>" 
                                                                                           corrector-id="<?= $question->corrector ?>">
                                                                                </div>
                                                                        <?php endif; ?>
                                                                <?php else: ?>
                                                                        <?php if (!empty($result->comment)): ?>                                                
                                                                                <div style="padding-top:8px">
                                                                                    <div>
                                                                                        <strong>
                                                                                            <?= $tr->_("Corrector's comments:") ?>
                                                                                        </strong>
                                                                                    </div>
                                                                                    <div>
                                                                                        <?= $result->comment ?>
                                                                                    </div>
                                                                                </div>
                                                                        <?php endif; ?>
                                                                <?php endif; ?>

                                                                <div style="clear:both"></div>                                                
                                                        <?php endif; ?>         

                                                <?php endforeach; ?>
                                                <?php if (!count($qSpecificAns)): ?>
                                                        <span style="background-color:#FEFF99">
                                                            <i><?= $tr->_("Student did not answer this question part.") ?></i>
                                                        </span>
                                                        <script>$("#<?= $question->id ?>-corrected").hide();</script>
                                                <?php endif; ?>
                                        <?php endif; ?>
                                    </div>
                                </div>
                                <?php $qPartCounter++; ?>
                        <?php endforeach; ?>        

                        <?php if ($loading == 'question'): ?>
                                <div class="st-ans-box">
                                    <?php foreach ($answers as $answer): ?>
                                            <?php $result = $answer->getResult(); ?>
                                            <?php $scoreData = (is_object($result) && $result->count() ? json_decode($result->score, true) : array()); ?>
                                            <div class="correction-section-box" style="margin-top: 15px" corrector="<?= $question->corrector ?>" correction="<?= $result->correction ?>">
                                                <?php if (!$exam->show_readonly && (count($scoreData) == 0 || !in_array($result->correction, array('completed', 'finalized')))): ?>
                                                        <?= Phalcon\Tag::image(array("img/not-corrected.gif", "style" => "position: absolute; right: 10px; width: 5%; min-width: 60px;", "class" => "not-corrected")); ?>
                                                <?php endif; ?>
                                                <?php $student = $answer->student; ?>
                                                <div class="st-ans-box-heading correction-section-head">
                                                    <span style="color:#514E4E; font-weight:normal">
                                                        <i class="fa fa-user"></i>
                                                        <?php if ($exam->show_code): ?>
                                                                <?= $tr->_("Students answer for this question") ?> (<?= $student->code ?>)
                                                        <?php else: ?>
                                                                <?= $tr->_("Students answer for this question") ?> (<?= $student->id ?>)
                                                        <?php endif; ?>
                                                    </span>
                                                </div>
                                                <?php
                                                $ansData = json_decode($answer->answer, true);
                                                if (!isset($ansData)) {
                                                        $ansData = array();
                                                }
                                                if (isset($ansData['highlight-q'])) {
                                                        unset($ansData['highlight-q']);
                                                }

                                                ?>

                                                <div class="st-ans-box-body q-body" style="padding-top:15px;">
                                                    <div class="st-ans-parts-wrapper" style="padding-bottom:15px;">
                                                        <?php $qPartCounter = 1; ?>
                                                        <?php foreach ($ansData as $qPartTitle => $qPart): ?>
                                                                <div class="st-ans-part" style="padding-bottom:5px">
                                                                    <?php if (count($ansData) > 1): ?>
                                                                            <div class="st-ans-part-title" style="padding-bottom:5px">
                                                                                <span style="color:#4285f4">Part <?= $qPartTitle ?>:</span>
                                                                            </div>
                                                                    <?php endif; ?>
                                                                    <div class="st-ans-part-content">
                                                                        <ul class="st-ans-ul" style="margin: 5px 0 0 30px; list-style:none; background-color:<?= (!$exam->show_readonly && !count($scoreData)) ? '#F5FAF5' : '#F9F9F9' ?>; padding:5px; border-left:5px solid #f0f0f0; max-width:95%">
                                                                            <?php $totalCorrect = 0; ?>
                                                                            <?php
                                                                            if (isset($correctAns[$question->id][$qPartTitle])) {
                                                                                    $correctAnsPart = $correctAns[$question->id][$qPartTitle];
                                                                            } else {
                                                                                    $correctAnsPart = array();
                                                                            }

                                                                            ?>
                                                                            <?php foreach ($ansData[$qPartTitle]['ans'] as $stAns): ?>
                                                                                    <?php if ($qPart['type'] == 'choicebox'): ?>
                                                                                            <li style="color:<?= (in_array($stAns, $correctAnsPart) ? 'green' : 'red') ?>">
                                                                                                <i class="fa fa-<?= (in_array($stAns, $correctAnsPart) ? 'check' : 'times') ?>"></i> 
                                                                                                <?= $stAns ?>
                                                                                                <?php in_array($stAns, $correctAnsPart) ? ++$totalCorrect : --$totalCorrect; ?>
                                                                                            </li>
                                                                                    <?php elseif ($qPart['type'] == 'canvas'): ?>
                                                                                            <li><img src="<?= $stAns['canvasUrl'] ?>" max-width="50%" /></li>
                                                                                    <?php else: ?>
                                                                                            <li><?= $stAns ?></li>
                                                                                    <?php endif; ?>

                                                                                    <?php if (empty($ansData[$qPartTitle]['ans'][0])): ?>
                                                                                            <li>
                                                                                                <i><?= $tr->_("Student did not answer this question.") ?></i>
                                                                                            </li>
                                                                                    <?php endif; ?>
                                                                            <?php endforeach; ?>
                                                                            <?php
                                                                            if ($totalCorrect < 0) {
                                                                                    $totalCorrect = 0;
                                                                            }

                                                                            ?>

                                                                            <?php if ($qPart['type'] == 'choicebox' && $totalCorrect && $totalCorrect != count($correctAnsPart)) : ?>
                                                                                    <li style="color:orange">
                                                                                        <i class="fa fa-warning"></i> 
                                                                                        <?= $tr->_("Student's answer is partially correct") ?>
                                                                                    </li>
                                                                            <?php endif; ?>
                                                                        </ul>
                                                                    </div>

                                                                    <div class="q-part-student-score savable" style="padding-top: 10px; padding-left: 35px; margin-bottom: 10px; display: <?= $questParts[$qPartTitle]['q_points'] == 0 ? 'none' : '' ?>">
                                                                        <i class="fa fa-certificate" style="color:#D84B4B"></i>
                                                                        <span style="color:#000;">
                                                                            <?= $tr->_("Points:") ?>
                                                                            <?php
                                                                            // 
                                                                            // Fill in score if max is zero on this question part.
                                                                            // 
                                                                            if (isset($qPart['q_points']) && $qPart['q_points'] == 0 && !isset($scoreData[$qPartTitle])) {
                                                                                    $scoreData[$qPartTitle] = 0;
                                                                                    printf("<script>resyncableResults.push('%d')</script>\n", $answer->id);
                                                                            }

                                                                            ?>

                                                                            <?php if (!$exam->show_readonly && $question->corrector): ?>
                                                                                    <input type="text" class="form-control q-points changeable" style="max-width: 80px" qst-id="<?= $answer->question_id ?>" ans-id="<?= $answer->id ?>" res-id="<?= count($scoreData) ? $result->id : 0 ?>" q-part="<?= $qPartTitle ?>" value="<?= isset($scoreData[$qPartTitle]) ? $scoreData[$qPartTitle] : ($qPart['type'] == 'choicebox' ? round($perOptPoints[$question->id][$qPartTitle] * $totalCorrect, 2) : '') ?>"  max-pt="<?= floatval($questParts[$qPartTitle]['q_points']) ?>" required="required">
                                                                            <?php else: ?>
                                                                                    <?= floatval($scoreData[$qPartTitle]) ?>
                                                                            <?php endif; ?>
                                                                            <span style="color: #4285f4; float: right; margin-right: 10px">[Max: <?= $questParts[$qPartTitle]['q_points'] ?>]</span>
                                                                        </span>
                                                                    </div>

                                                                    <?php if (!$exam->show_readonly && $question->corrector): ?>
                                                                            <?php if (count($ansData) == $qPartCounter): ?>
                                                                                    <div class="savable" style="padding-top: 10px; padding-left:35px">
                                                                                        <i class="fa fa-comments"></i>
                                                                                        <?= $tr->_("Comments:") ?>
                                                                                        <br />
                                                                                        <textarea class="form-control changeable no-print" 
                                                                                                  placeholder="<?= $tr->_("Add your comments here for the student") ?>" 
                                                                                                  style="margin-left: 15px; width:30%" 
                                                                                                  qst-id="<?= $answer->question_id ?>" 
                                                                                                  ans-id="<?= $answer->id ?>">
                                                                                                      <?= $result->comment ?>
                                                                                        </textarea>
                                                                                    </div>

                                                                                    <div class="savable no-print" style="padding-top: 10px; padding-left: 45px;">
                                                                                        <input class="btn btn-success save-result no-print" 
                                                                                               type="button" 
                                                                                               qst-id="<?= $answer->question_id ?>" 
                                                                                               ans-id="<?= $answer->id ?>" 
                                                                                               value="<?= $tr->_("Save this result") ?>" 
                                                                                               corrector-id="<?= $question->corrector ?>">
                                                                                    </div>
                                                                            <?php endif; ?>
                                                                    <?php else: ?>
                                                                            <?php if (!empty($result->comment)): ?>
                                                                                    <div>
                                                                                        <div>
                                                                                            <strong>
                                                                                                <?= $tr->_("Corrector's comments:") ?>
                                                                                            </strong>
                                                                                        </div>
                                                                                        <div>
                                                                                            <?= $result->comment ?>
                                                                                        </div>
                                                                                    </div>
                                                                            <?php endif; ?>
                                                                    <?php endif; ?>
                                                                    <div style="clear:both"></div>                                                

                                                                </div>
                                                                <?php $qPartCounter++; ?>
                                                        <?php endforeach; ?>

                                                        <?php if (!count($ansData)): ?>
                                                                <span style="background-color:#FEFF99">
                                                                    <i><?= $tr->_("Student did not answer this question part.") ?></i>
                                                                </span>
                                                        <?php endif; ?>
                                                    </div>
                                                </div>
                                            </div>
                                    <?php endforeach; ?>
                                </div>
                        <?php endif; ?>
                    </div>
                </div>
        <?php endforeach; ?>
        <br />
    </div>
</div>

<?php if ($exam->decoded == false) : ?>
        <div class="no-print" style="position: fixed; bottom: -30px; right: 30px; padding: 10px; background-color: whitesmoke; border-radius: 5px; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.2), 0 5px 20px 0 rgba(0, 0, 0, 0.2); z-index: 2;">
            <div>
                <?php $onclick = sprintf("return render_pdf_document('%s','%s')", urlencode($this->request->get("_url")), $this->url->get("utility/render/pdf")) ?>
                <a href="#" style="float: right; padding: 5px" onclick="<?= $onclick ?>" title="<?= $tr->_("Download current view as PDF document") ?>">
                    <i class="fa fa-file-pdf-o fa-2x" aria-hidden="true"></i>
                </a>
                <?php $onclick = sprintf("return render_url_document('%s')", urlencode($this->request->get("_url"))) ?>
                <a href="#" style="float: right; padding: 5px" onclick="<?= $onclick ?>" title="<?= $tr->_("View online in print friendly format") ?>">
                    <i class="fa fa-print fa-2x" aria-hidden="true"></i>
                </a>
                <a href="#" style="float: right; padding: 5px" id="reset-student-results" title="<?= $tr->_("Reset all results found on this view") ?>">
                    <i class="fa fa-window-restore fa-2x" aria-hidden="true"></i>
                </a>
            </div>
            <hr style="clear: both; margin: 0">
            <div style="padding-left: 10px; padding-top: 5px">
                <div class="checkbox">
                    <label>
                        <input type="checkbox" class="hide-completed">
                        <?= $tr->_("Hide fully corrected answers") ?>
                    </label>
                </div>
                <div class="checkbox">
                    <label>
                        <input type="checkbox" class="hide-resources">
                        <?= $tr->_("Hide media and resource files") ?>
                    </label>
                </div>
                <div class="checkbox">
                    <label>
                        <input type="checkbox" class="hide-uncorrectable">
                        <?= $tr->_("Hide uncorrectable answers") ?>
                    </label>
                </div>
            </div>
            <?php if ($question->corrector != "none") : ?>
                    <input type="button" 
                           class="btn btn-success btn-lg save-all-result savable" 
                           corrector-id="<?= $question->corrector ?>" 
                           value="<?= $tr->_("Save all results") ?> Â»">
            <?php endif; ?>
        </div>
<?php endif; ?>

<form id="download-pdf" action="" style="display: none">
    <input id="download-url" type="hidden" name="url" value="">
    <input type="submit">
</form>

<script>
                                // 
                                // Trigger download of PDF document:
                                // 
                                function render_pdf_document(url, render) {
                                    window.location.href = render + '?url=' + url;
                                    return false;
                                }

                                // 
                                // Trigger print of URL:
                                // 
                                function online_url_document(url) {
                                    window.location.href = url + "#print";
                                    return false;
                                }

                                // 
                                // Popup print dialog if hash-bang is set:
                                // 
                                document.addEventListener("DOMContentLoaded", function () {
                                    if (window.location.hash && window.location.hash === '#print') {
                                        window.print();
                                    }
                                });

</script>
